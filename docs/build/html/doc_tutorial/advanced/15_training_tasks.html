

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Tasks &mdash; ViUR Core 3.0.0-b1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Sessions" href="10_training_session.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ViUR Core
          

          
          </a>

          
            
            
              <div class="version">
                3.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">ViUR Core</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../doc_start/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc_guide/index.html">Reference Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../basic/index.html">Basis Tutorials</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Advanced Tutorials</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="05_training_config.html">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="10_training_session.html">Sessions</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Tasks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#time-based">Time based</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deferred">Deferred</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-demand">On Demand</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-instance-startup">On instance startup</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ViUR Core</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Tutorials</a> &raquo;</li>
        
          <li><a href="index.html">Advanced Tutorials</a> &raquo;</li>
        
      <li>Tasks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/doc_tutorial/advanced/15_training_tasks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tasks">
<h1>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h1>
<p>ViUR is shipped with a sophisticated interface for tasks, providing a standardized way of
having a function called in a regular interval, providing an interface for tasks that
can be called by the user on demand, and deferring functionality from the current request.</p>
<div class="section" id="time-based">
<h2>Time based<a class="headerlink" href="#time-based" title="Permalink to this headline">¶</a></h2>
<p>A common problem on the GAE is having certain functionality executed in a regular interval.
ViUR simplifies this down to a decorator. Just wrap a function with <code class="xref py py-meth docutils literal notranslate"><span class="pre">server.tasks.PeriodicTask()</span></code> and
ViUR will call it in a regular interval.
The decorator takes one argument - the interval in minutes.
ViUR will not call your function faster than once in each interval-minutes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">server.tasks</span> <span class="kn">import</span> <span class="n">PeriodicTask</span>

<span class="nd">@PeriodicTask</span><span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mytask</span><span class="p">():</span>  <span class="c1"># Will be called roughly every 24 hours</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Your deferred task was just called :)&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is the <em>lower</em> bound. There is no guarantee that it will be called
each ‘interval’ minutes. The upper bound is defined in cron.yaml and currently defaults
to each 4 hours.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Time-based tasks can be a bound or unbound Function. If a function is bound (defined
in a class) it will be called once for each module derived from this class. If there is no instance
of its class, it won’t be called. If its unbound (defined at module-level) it will be called,
regardless if any Class in its module is used or not (but the module itself needs to be imported).</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There’s currently only a main loop which calls all function scheduled for execution. It has a time-limit of 10 minutes.
If your task takes more than a few minutes to execute, you should defer that code. Otherwise your tasks (all tasks in total)
might exceed these 10 minutes, which causes the request to be aborted despite not all tasks had been called yet.</p>
</div>
</div>
<div class="section" id="deferred">
<h2>Deferred<a class="headerlink" href="#deferred" title="Permalink to this headline">¶</a></h2>
<p>Sometimes its necessary to delay the execution of some specific code, so it won’t slow down the
response of the current request. ViUR provides the <code class="xref py py-meth docutils literal notranslate"><span class="pre">server.tasks.callDefered()</span></code> Decorator for such cases.
A function decorated this way will never execute in the context of the current request. All calls to
such a function are catched, its parameters serialized, and a task is created to call this function later.
These calls are executed in a deferred task which can run up to 10 minutes. As these tasks run deferred, they run outside
of the current context where they had been created. ViUR however will preserve the following two values:</p>
<blockquote>
<div><ul class="simple">
<li><p>The currently logged in user (if any). If the task was created in the context of a known user, calls to utils.getCurrentUser()
will return the same values as it would have returned when the task had been created.</p></li>
<li><p>The language used for the request. Within the deferred task any calls to i18N functions provided by ViUR will yield
results in the language of the original request.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A deferred function cannot return a value! The return-value for the code calling such a function
will always be None, and any return-value generated by the function (when its actually called) will be discarded.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This replaces the deferred-api provided by the GAE itself. Don’t use it - it will break assumptions
made by ViUR!</p>
</div>
</div>
<div class="section" id="on-demand">
<h2>On Demand<a class="headerlink" href="#on-demand" title="Permalink to this headline">¶</a></h2>
<p>The third use-case for tasks is on demand: A task that’s run infrequently by the user.
One example is our rebuild searchindex task: If changes are made to a data-model (ie. include
the contents of a Bone in the fulltext search), and there is already data in the datastore
created by the old model, its necessary to update the searchindex, as it doesn’t contain
the contents of that bone yet.
It would be a waste of resources if we rebuild each index frequently.
So this task is only called on demand. If the developer has made changes to the datamodel,
he calls that task once for each affected kind.
Creating such a task is also easy, it’s a Class derived from <code class="xref py py-class docutils literal notranslate"><span class="pre">server.tasks.CallableTaskBase</span></code> and decorated with
<code class="xref py py-meth docutils literal notranslate"><span class="pre">server.tasks.CallableTask()</span></code>. The derived subclass must override the following properties and functions.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 12%" />
<col style="width: 25%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>key</p></td>
<td><p>Property (String)</p></td>
<td><p>An unique identifier for this task.</p></td>
</tr>
<tr class="row-odd"><td><p>name</p></td>
<td><p>Property (String)</p></td>
<td><p>A short human-readable description</p></td>
</tr>
<tr class="row-even"><td><p>descr</p></td>
<td><p>Property (String)</p></td>
<td><p>A longer explanation</p></td>
</tr>
<tr class="row-odd"><td><p>canCall</p></td>
<td><p>Function</p></td>
<td><p>Must return True if the current user (if any) is allowed
to execute that task. Return False otherwise.</p></td>
</tr>
<tr class="row-even"><td><p>dataSkel</p></td>
<td><p>Function or Skeleton-class</p></td>
<td><p>If your tasks need additional Input (ie: which searchindex?)
from the user, query him by returning an skeleton.
Return None if you don’t need any information.</p></td>
</tr>
<tr class="row-odd"><td><p>execute</p></td>
<td><p>Function</p></td>
<td><p>Does the actual work. If you returned a skeleton in <em>dataSkel</em>,
the values of that Skeleton are passed as keyword arguments.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="on-instance-startup">
<h2>On instance startup<a class="headerlink" href="#on-instance-startup" title="Permalink to this headline">¶</a></h2>
<p>The last hook you can use is the <code class="xref py py-meth docutils literal notranslate"><span class="pre">server.tasks.StartupTask()</span></code> decorator. This way you can have code being executed
whenever a new instance starts up without slowing down the instance startup itself (The code will be called deferred
shortly after an instance gets ready).
Useful to ensure some database initialization or the like.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There’s absolutely <strong>no</strong> guarantee that the function will be called on the instance that started up. It can
be called any of the currently running instances. So it’s possible that such a function is called
never, once or multiple times on the same instance. Do not put any code here required to correctly
setup your instances.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="10_training_session.html" class="btn btn-neutral float-left" title="Sessions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Mausbrand Informationssysteme GmbH.
      <span class="lastupdated">
        Last updated on Mar 12, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>