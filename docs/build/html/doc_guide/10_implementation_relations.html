

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Relations &mdash; ViUR Core 3.0.0-b1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="RandomSliceBone" href="15_implementation_randomSliceBone.html" />
    <link rel="prev" title="Data consistency" href="05_implementation_consistency.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> ViUR Core
          

          
          </a>

          
            
            
              <div class="version">
                3.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">ViUR Core</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../doc_start/index.html">Getting started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Reference Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="05_implementation_consistency.html">Data consistency</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Relations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#filtering-by-properties-of-the-referenced-object">Filtering by properties of the referenced object</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-values">Updating values</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="15_implementation_randomSliceBone.html">RandomSliceBone</a></li>
<li class="toctree-l2"><a class="reference internal" href="20_implementation_spatialBone.html">SpatialBone</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../doc_tutorial/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ViUR Core</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Reference Guide</a> &raquo;</li>
        
      <li>Relations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/doc_guide/10_implementation_relations.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="relations">
<h1>Relations<a class="headerlink" href="#relations" title="Permalink to this headline">¶</a></h1>
<p>ViUR provides relations ontop of the non-relational datastore. In the following we’ll explain how these relations are
implemented, what are the limits of this implementation and how much overhead it produces.</p>
<div class="section" id="filtering-by-properties-of-the-referenced-object">
<h2>Filtering by properties of the referenced object<a class="headerlink" href="#filtering-by-properties-of-the-referenced-object" title="Permalink to this headline">¶</a></h2>
<p>In ViUR, the actual implementation of relations depend on their type. For n:1 relations (i.e. an object is referring
<em>one</em> other object, we can simply copy the key (and everything from <cite>refKeys</cite>) into the referring object.
Assume we have a Skeleton “Product” consisting of a Name, Price and Category, with Categrory being a reference
to separate Skeleton “Category”.</p>
<div class="align-center figure" id="id1">
<img alt="Datamodel for this example of n:1 Relations" src="../_images/relations1.png" />
<p class="caption"><span class="caption-text">Datamodel for this example of n:1 Relations</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>Lets assume that <em>key</em>, <em>available</em> and <em>active</em> is in the refKeys for that relation, so we can filter by products which
are in a category, which is available in a given region and generally active.
The final object written to the datastore for our product will be denormalized and look like the following</p>
<div class="align-center figure" id="id2">
<img alt="Deserialized object in the datastore" src="../_images/relations2.png" />
<p class="caption"><span class="caption-text">Deserialized object in the datastore</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>For n:m relations, this trick won’t work. We would get a list of values for each referenced property, collecting all
values for that property from all referenced objects at once:</p>
<div class="align-center figure" id="id3">
<img alt="Deserialized object in the datastore if we do n:m relations that way" src="../_images/relations3.png" />
<p class="caption"><span class="caption-text">Deserialized object in the datastore if we do n:m relations that way</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>Now filtering by two properties of the referenced object could mess up. If we would filter by products which’s category
is available in a given region <em>and</em> is active, the query would also return results, which have at least one active
category, and one (possibly <em>different</em>) category that’s available in the given region.
So assume we’ve referenced two categories, one available in [“de”,”at”,”ch”] and being active, the other one not active
and available in [“gb”, “us”], a query by active=True <em>and</em> available=”gb” should not yield that entity as a result.
Yet, with this model, it does. So it’s impossible to enforce that both requirements are meet by the same referenced category.</p>
<p>So for n:m relations, ViUR uses a different approach. We’ll just store the Json-Encoded data from the referenced object
inside the referring object (so that fetching this object from the datastore contains all required information needed
for that relational bone, so we don’t need to fetch the referenced entity also). To allow efficient filtering, we
create an new object in the datastore for each object referenced. We’ll copy each property named in refKeys from the
referenced object into this new object (prefixed with “dest.”), and each property named in parentKeys from the referring
object. Also the key of the referring and referred, their kinds and the name of the relationalBone are written to these
objects.</p>
<div class="align-center figure" id="id4">
<img alt="Example of viur-relation objects" src="../_images/relations4.png" />
<p class="caption"><span class="caption-text">Example of viur-relation objects</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>As a further optimisation, we’ll store theses viur-relation objects under the referring object (the referring object
becomes the parent for these objects). So while querying using viur-relations, we’ll only fetch the keys of these
objects machtech - never the viur-relations objects itself.
Having the keys, we can extract the keys of the parent from these keys and we can fetch them directly.</p>
</div>
<div class="section" id="updating-values">
<h2>Updating values<a class="headerlink" href="#updating-values" title="Permalink to this headline">¶</a></h2>
<p>The second challenge is keeping this data consistent. As we copy data from the referenced object either into the
referring object or into itermediate viur-relation objects, we need a way to update this data if the referred object
is edited. As the viur-relation objects are updated each time the referring object is saved, we’ll only need to cover
the case the referred object changes. So everytime a skeleton is updated, ViUR creates a deferred task, which checks
the viur-relation table if this entity is referenced by any other entity and updates these entries accordingly.
For n:1 relations, we could either check the data-models if there are any n:1 to the kind of the entry changed (which
might require several queries and indexes, or we could also write a small viur-relational entry. We’ve choosed to write
the viur-relational entry (just containing the keys and kinds of both entries and name of the bone) so we can save a lot
of compound indexes here. There are also some other tweaks to keep the overhead low, like writing a last update
timestamp into these objects, so an object won’t get updated twice if it contains two seperate relations to the changed
object.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Theses updates don’t cascade. If you name properties in refKeys, which have been copied in the referenced entity
itself by another relation there, this won’t be updated! So if you have
Entry a –&gt; relation1 –&gt; Entry b –&gt; relation2 –&gt; Entry c
and Entry c is updated, <em>only</em> data in Entry b gets updated too. If you have listed something like “relation2.name”
in the refKeys of relation1, this will be missed and Entry a (or its viur-relation object’s) will still contain
the old value for relation2.name</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="15_implementation_randomSliceBone.html" class="btn btn-neutral float-right" title="RandomSliceBone" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="05_implementation_consistency.html" class="btn btn-neutral float-left" title="Data consistency" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Mausbrand Informationssysteme GmbH.
      <span class="lastupdated">
        Last updated on Mar 12, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>